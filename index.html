<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Neon Snake</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root {
            --bg: #050505;
            --primary: #00ffcc;
            --accent: #ff00ff;
            --text: #ffffff;
            --ui-bg: rgba(10, 10, 10, 0.95);
        }

        html, body { height: 100%; margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; }
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        h1 { font-size: 18px; margin: 0; color: var(--primary); text-shadow: 0 0 8px var(--primary); }
        .stats { font-family: monospace; font-size: 14px; color: #aaa; }
        .stats b { color: #fff; }

        #game-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; height: calc(100vh - 100px); }
        canvas { background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        #ui-layer { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 20; }
        #ui-layer.hidden { display: none; }
        
        .menu-box { text-align: center; background: var(--ui-bg); padding: 25px; border: 1px solid #444; border-radius: 12px; width: 320px; max-height: 85vh; overflow-y: auto; }
        
        /* Collapsible Shop Logic */
        .shop-trigger { 
            background: #222; color: #fff; border: 1px solid #444; padding: 10px; width: 100%; 
            margin-top: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .shop-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #111; border-radius: 0 0 6px 6px; }
        .shop-content.open { max-height: 400px; padding: 10px 0; border: 1px solid #444; border-top: none; }

        .skin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 10px; }
        .skin-card { background: #1a1a1a; border: 1px solid #333; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .skin-card.selected { border-color: var(--primary); background: #002211; }
        .preview-dot { width: 12px; height: 12px; margin: 0 auto 5px; border-radius: 2px; }

        .btn-play { background: var(--primary); color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; border-radius: 4px; margin-top: 20px; cursor: pointer; }
        .speed-selector { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .speed-btn { background: none; border: 1px solid #444; color: #888; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 4px; }
        .speed-btn.active { border-color: var(--primary); color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <h1>NEON SNAKE</h1>
        <div class="stats">HIGH: <b id="high">0</b> | BANK: <b id="bank">0</b></div>
    </header>

    <div id="game-container">
        <canvas id="c"></canvas>
        <div id="ui-layer">
            <div class="menu-box">
                <h2 id="menu-text" style="margin-top:0">READY?</h2>
                <div id="final-score" style="color:var(--primary); font-weight:bold; margin-bottom:10px"></div>

                <div class="speed-selector">
                    <button class="speed-btn" onclick="setSpeed('slow', this)">SLOW</button>
                    <button class="speed-btn" onclick="setSpeed('normal', this)">NORMAL</button>
                    <button class="speed-btn active" onclick="setSpeed('hard', this)">HARD</button>
                </div>

                <button class="shop-trigger" onclick="toggleShop('snake-shop')">SNAKE SKINS <span>+</span></button>
                <div id="snake-shop" class="shop-content">
                    <div class="skin-grid" id="snake-grid"></div>
                </div>

                <button class="shop-trigger" onclick="toggleShop('ball-shop')">BALL SKINS <span>+</span></button>
                <div id="ball-shop" class="shop-content">
                    <div class="skin-grid" id="food-grid"></div>
                </div>

                <button class="btn-play" onclick="startGame()">START GAME</button>
                <p style="font-size:10px; color:#555">WASD to Move | Q to Panic Exit</p>
            </div>
        </div>
    </div>

<script>
/* ================= DATA & STORAGE ================= */
const SNAKE_SKINS = [
    { id: 's1', name: 'NEON', head: '#00ffcc', body: '#00bfa5', price: 0 },
    { id: 's2', name: 'GOLD', head: '#ffcc00', body: '#aa8800', price: 15 },
    { id: 's3', name: 'RUBY', head: '#ff0044', body: '#990022', price: 30 },
    { id: 's4', name: 'AMETHYST', head: '#bf00ff', body: '#7700bb', price: 45 },
    { id: 's5', name: 'COBALT', head: '#0066ff', body: '#0033aa', price: 75 }
];

const FOOD_SKINS = [
    { id: 'f1', name: 'PURPLE', color: '#ff00ff', price: 0 },
    { id: 'f2', name: 'LIME', color: '#ccff00', price: 15 },
    { id: 'f3', name: 'CYAN', color: '#00ffff', price: 30 },
    { id: 'f4', name: 'ORANGE', color: '#ff9900', price: 45 },
    { id: 'f5', name: 'WHITE', color: '#ffffff', price: 75 }
];

let bank = parseInt(localStorage.getItem('snake_bank') || '0');
let high = parseInt(localStorage.getItem('snake_high') || '0');
let owned = JSON.parse(localStorage.getItem('snake_owned') || '["s1", "f1"]');
let activeS = JSON.parse(localStorage.getItem('active_s')) || SNAKE_SKINS[0];
let activeF = JSON.parse(localStorage.getItem('active_f')) || FOOD_SKINS[0];
let currentSpeed = 'hard';

function save() {
    localStorage.setItem('snake_bank', bank);
    localStorage.setItem('snake_high', high);
    localStorage.setItem('snake_owned', JSON.stringify(owned));
    localStorage.setItem('active_s', JSON.stringify(activeS));
    localStorage.setItem('active_f', JSON.stringify(activeF));
    document.getElementById('bank').textContent = bank;
    document.getElementById('high').textContent = high;
}

/* ================= UI LOGIC ================= */
function toggleShop(id) {
    const el = document.getElementById(id);
    const isOpen = el.classList.contains('open');
    document.querySelectorAll('.shop-content').forEach(s => s.classList.remove('open'));
    if (!isOpen) el.classList.add('open');
}

function renderShops() {
    const build = (list, gridId, activeObj, type) => {
        const grid = document.getElementById(gridId);
        grid.innerHTML = '';
        list.forEach(skin => {
            const isOwned = owned.includes(skin.id);
            const isSel = activeObj.id === skin.id;
            const card = document.createElement('div');
            card.className = `skin-card ${isSel ? 'selected' : ''}`;
            card.innerHTML = `<div class="preview-dot" style="background:${skin.head || skin.color}"></div>
                <b>${skin.name}</b><br>${isSel ? 'ACTIVE' : (isOwned ? 'OWNED' : skin.price + ' c')}`;
            card.onclick = () => {
                if (isOwned) {
                    if (type === 's') activeS = skin; else activeF = skin;
                } else if (bank >= skin.price) {
                    bank -= skin.price; owned.push(skin.id);
                    if (type === 's') activeS = skin; else activeF = skin;
                }
                save(); renderShops();
            };
            grid.appendChild(card);
        });
    };
    build(SNAKE_SKINS, 'snake-grid', activeS, 's');
    build(FOOD_SKINS, 'food-grid', activeF, 'f');
}

function setSpeed(mode, btn) {
    currentSpeed = mode;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

/* ================= GAME ENGINE ================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const COLS = 31, ROWS = 15;
let cellSize, snake, dir, nextDir, food, score, gameOver = true, lastTime, accum = 0;

function resize() {
    cellSize = Math.floor(Math.min((window.innerWidth-40)/COLS, (window.innerHeight-150)/ROWS));
    canvas.width = COLS * cellSize; canvas.height = ROWS * cellSize;
}
window.onresize = resize; resize();

function spawnFood() {
    food = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
    if (snake.some(p => p.x === food.x && p.y === food.y)) spawnFood();
}

function startGame() {
    snake = [{x:10, y:7}, {x:9, y:7}, {x:8, y:7}];
    dir = {x:1, y:0}; nextDir = []; score = 0; gameOver = false;
    spawnFood();
    document.getElementById('ui-layer').classList.add('hidden');
    lastTime = performance.now();
    requestAnimationFrame(loop);
}

window.onkeydown = e => {
    const k = e.key.toLowerCase();
    if (k === 'q') window.location.href = "https://google.com";
    let nD = null;
    if (k === 'w' || k === 'arrowup') nD = {x:0, y:-1};
    if (k === 's' || k === 'arrowdown') nD = {x:0, y:1};
    if (k === 'a' || k === 'arrowleft') nD = {x:-1, y:0};
    if (k === 'd' || k === 'arrowright') nD = {x:1, y:0};
    if (nD && (nextDir.length < 2)) {
        const last = nextDir.length > 0 ? nextDir[nextDir.length-1] : dir;
        if (nD.x !== -last.x || nD.y !== -last.y) nextDir.push(nD);
    }
};

function loop(t) {
    if (gameOver) return;
    const dt = t - lastTime; lastTime = t; accum += dt;
    const spd = {slow:120, normal:80, hard:60}[currentSpeed];
    
    while (accum > spd) {
        if (nextDir.length > 0) dir = nextDir.shift();
        const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
        
        if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS || snake.some(p => p.x === head.x && p.y === head.y)) {
            gameOver = true;
            if (score > high) high = score;
            bank += score; // Score adds to bank at the end of the game
            save();
            document.getElementById('menu-text').textContent = "GAME OVER";
            document.getElementById('final-score').textContent = "+" + score + " COINS EARNED";
            document.getElementById('ui-layer').classList.remove('hidden');
            renderShops();
            return;
        }

        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
            score++; spawnFood();
        } else snake.pop();
        accum -= spd;
    }

    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // Grid
    ctx.strokeStyle = '#111';
    for(let i=0; i<=COLS; i++) { ctx.moveTo(i*cellSize,0); ctx.lineTo(i*cellSize, canvas.height); }
    for(let i=0; i<=ROWS; i++) { ctx.moveTo(0,i*cellSize); ctx.lineTo(canvas.width, i*cellSize); }
    ctx.stroke();

    // Food
    ctx.fillStyle = activeF.color;
    ctx.beginPath(); ctx.arc(food.x*cellSize+cellSize/2, food.y*cellSize+cellSize/2, cellSize/3, 0, Math.PI*2); ctx.fill();

    // Snake
    snake.forEach((s, i) => {
        ctx.fillStyle = (i === 0) ? activeS.head : activeS.body;
        ctx.beginPath(); ctx.roundRect(s.x*cellSize+1, s.y*cellSize+1, cellSize-2, cellSize-2, 4); ctx.fill();
    });

    requestAnimationFrame(loop);
}

save(); renderShops();
</script>
</body>
</html>
